{% extends "base.html" %}

{% block title %}MixTool - Professional Audio Mastering{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card mb-4">
            <div class="card-body text-center py-5">
                <h1 class="display-5 fw-bold mb-3">Professional Audio Mastering Made Simple</h1>
                <p class="lead mb-4">Transform your tracks with our intelligent mastering technology. No complicated settings, just great sounding masters.</p>
            </div>
        </div>
        
        <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" id="masteringForm">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Upload Your Track</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="targetFile" class="form-label">Your Track (to be mastered):</label>
                        <input type="file" class="form-control form-control-lg" id="targetFile" name="target_file" accept="audio/*" required>
                        <small class="text-muted">Upload any audio file (WAV, MP3, AIFF, etc.)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format:</label>
                        <select class="form-select" id="exportFormat" name="export_format">
                            <option value="wav">WAV (Highest Quality)</option>
                            <option value="mp3">MP3 (Smaller File Size)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Mastering Method</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="mastering-option active" id="parameterOption">
                                <h5>Parameter-Based Mastering</h5>
                                <p>Use our intelligent algorithm to enhance your track with customizable settings.</p>
                                <input type="radio" name="mastering_method" value="parameter" checked style="display:none" id="parameterRadio">
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="mastering-option" id="referenceOption">
                                <h5>Reference-Based Mastering {% if not matchering_available %}<small class="text-muted">(Unavailable)</small>{% endif %}</h5>
                                <p>Make your track sound like a professionally mastered reference track.</p>
                                <input type="radio" name="mastering_method" value="reference" style="display:none" id="referenceRadio" {% if not matchering_available %}disabled{% endif %}>
                            </div>
                        </div>
                    </div>
                    
                    <div id="referenceUpload" style="display:none">
                        <div class="mb-3 mt-3">
                            <label for="referenceFile" class="form-label">Reference Track:</label>
                            <input type="file" class="form-control" id="referenceFile" name="reference_file" accept="audio/*">
                            <small class="text-muted">Upload a professionally mastered track that you want your track to sound like</small>
                        </div>
                    </div>
                    
                    <div id="parameterControls" class="parameter-controls">
                        <h5 class="mb-3">Mastering Settings</h5>
                        
                        <div class="mb-4">
                            <label for="bassBoost" class="form-label">Bass Boost</label>
                            <input type="range" class="form-range" min="0" max="10" step="1" id="bassBoost" name="bass_boost" value="5">
                            <div class="range-label">
                                <span>Light</span>
                                <span>Heavy</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="brightness" class="form-label">Brightness/Clarity</label>
                            <input type="range" class="form-range" min="0" max="10" step="1" id="brightness" name="brightness" value="5">
                            <div class="range-label">
                                <span>Warm</span>
                                <span>Bright</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="compression" class="form-label">Compression</label>
                            <input type="range" class="form-range" min="0" max="10" step="1" id="compression" name="compression" value="5">
                            <div class="range-label">
                                <span>Subtle</span>
                                <span>Strong</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="stereoWidth" class="form-label">Stereo Width</label>
                            <input type="range" class="form-range" min="0" max="10" step="1" id="stereoWidth" name="stereo_width" value="5">
                            <div class="range-label">
                                <span>Narrow</span>
                                <span>Wide</span>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="loudness" class="form-label">Target Loudness</label>
                            <input type="range" class="form-range" min="-20" max="-6" step="1" id="loudness" name="loudness" value="-14">
                            <div class="range-label">
                                <span>Quiet (-20 LUFS)</span>
                                <span>Loud (-6 LUFS)</span>
                            </div>
                            <div class="text-center">
                                <span id="loudnessValue">-14 LUFS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-5">
                <button type="submit" class="btn btn-primary btn-lg px-5" id="submitButton">Master My Track</button>
            </div>
            
            <div id="loading-indicator" style="display:none">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your track... This may take a few minutes.</p>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row mt-5">
    <div class="col-12">
        <h2 class="text-center mb-4">How It Works</h2>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="bi bi-upload"></i>
                </div>
                <h5>1. Upload Your Track</h5>
                <p>Select your audio file in any common format (WAV, MP3, AIFF, FLAC).</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="bi bi-sliders"></i>
                </div>
                <h5>2. Choose Your Settings</h5>
                <p>Select a mastering method and adjust parameters to suit your track's style.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="bi bi-download"></i>
                </div>
                <h5>3. Download Your Master</h5>
                <p>Get your professionally mastered track ready for release.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle mastering method selection
    function selectMasteringMethod(method) {
        if (method === 'parameter') {
            document.getElementById('parameterOption').classList.add('active');
            document.getElementById('referenceOption').classList.remove('active');
            document.getElementById('parameterRadio').checked = true;
            document.getElementById('referenceUpload').style.display = 'none';
            document.getElementById('parameterControls').style.display = 'block';
        } else {
            document.getElementById('parameterOption').classList.remove('active');
            document.getElementById('referenceOption').classList.add('active');
            document.getElementById('referenceRadio').checked = true;
            document.getElementById('referenceUpload').style.display = 'block';
            document.getElementById('parameterControls').style.display = 'block';
        }
    }
    
    // Update loudness value display
    document.getElementById('loudness').addEventListener('input', function() {
        document.getElementById('loudnessValue').textContent = this.value + ' LUFS';
    });
    
    // Configure form submission
    document.getElementById('masteringForm').addEventListener('submit', function(event) {
        // Validate required fields
        const targetFile = document.getElementById('targetFile');
        const referenceMethod = document.getElementById('referenceRadio').checked;
        const referenceFile = document.getElementById('referenceFile');
        
        if (!targetFile.files.length) {
            event.preventDefault();
            alert('Please select a track to master');
            return;
        }
        
        if (referenceMethod && !referenceFile.files.length) {
            event.preventDefault();
            alert('Please select a reference track or switch to parameter-based mastering');
            return;
        }
        
        // Show loading indicator
        document.getElementById('submitButton').disabled = true;
        document.getElementById('loading-indicator').style.display = 'block';
    });
    
    // Set up mastering option selection
    document.getElementById('parameterOption').addEventListener('click', function() {
        selectMasteringMethod('parameter');
    });
    
    document.getElementById('referenceOption').addEventListener('click', function() {
        selectMasteringMethod('reference');
    });
</script>
{% endblock %}